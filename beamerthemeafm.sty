\usepackage{multicol}
\usepackage{amsmath}
%\usepackage[bb=dsserif]{mathalpha}
\usepackage{bbm}
\usepackage{cancel}
\usepackage{xcolor}
\usepackage{pifont}

\newcommand{\ito}{It$\hat{o}$}
\newcommand{\expect}[1]{\mathbb{E}^\mathbb{#1}}
\newcommand{\expectt}[2]{\mathbb{E}_{#2}^\mathbb{#1}}

\newcommand{\myendproof}{\hfill\qedsymbol}

\newsavebox\MBox
\newcommand\Cline[2][red]{{\sbox\MBox{$#2$}%
  \rlap{\usebox\MBox}\color{#1}\rule[-1.2\dp\MBox]{\wd\MBox}{0.5pt}}}

\newcommand{\goodcheck}{\color{green}\ding{52}}
\newcommand{\badcheck}{\color{red}\ding{56}}

\RequirePackage{etoolbox}
\RequirePackage{tikz}
\usetikzlibrary{calc,positioning}

\RequirePackage{geometry}
%\geometry{paperwidth=25.4cm,paperheight=14.2875cm}
\geometry{paperwidth=16.93cm,paperheight=9.525cm}

%\RequirePackage{caladea,carlito}
%\renewcommand{\familydefault}{\sfdefault}

% No navigation symbols
\setbeamertemplate{navigation symbols}{}

\RequirePackage{graphicx}

\RequirePackage{xcolor}

% colours
\definecolor{maincolor}{RGB/cmyk}{130,36,51/10,100,61,50}
\definecolor{blue(pigment)}{rgb}{0.2, 0.2, 0.6}
\definecolor{sintefgrey}{RGB/cmyk}{235,235,230/0,0,0,.1}
\colorlet{sintefgray}{sintefgrey}
\definecolorset{RGB/cmyk}{sintef}{}{lightgreen, 205,250,225/.23, 0,.20, 0;%
	green,       20,185,120/.73, 0,.67, 0;%
	darkgreen,    0, 70, 40/.93,.43,.92,.52}
\definecolorset{RGB/cmyk}{sintef}{}{yellow, 200,155,20/20, 36,98, 8;%
	red,    190, 60,55/19, 86,77, 8;%
	lilla,  120,  0,80/48,100,27,31}
\definecolorset{HTML}{sintef}{}{cyan,      22A7E5;%
	magenta,   EC008C;%
	lightgrey, D8D0C7}
\colorlet{sinteflightgray}{sinteflightgrey}

\hypersetup{colorlinks,linkcolor=,urlcolor=maincolor}

\usepackage[capitalize]{cleveref}
\let\chyperref\cref
\renewcommand{\cref}[1]{\hyperlink{#1}{\chyperref{#1}}}

\newcommand{\atfootlineauthor}{\insertauthor \enspace$\vert$\enspace}
\newcommand{\atfootlinepayoff}{\atfootlineauthor\inserttitle}
\newcommand{\footlinepayoff}[1]{\renewcommand{\atfootlinepayoff}{#1}}

%Define footline content
\setbeamertemplate{footline}{%
	\begin{beamercolorbox}[wd=\textwidth,ht=5mm,dp=3mm,rightskip=1cm,leftskip=0.3cm]{footline}
		\insertframenumber/\inserttotalframenumber\hskip20pt
		\ifstrempty{\atfootlinepayoff}{}{%
			\usebeamerfont{footline}\hfill\atfootlinepayoff
		}
	\end{beamercolorbox}
}

% Set footline AND coordinate blocks with it
\newcommand{\footlinecolor}[1]{% if #1 is empty, makes footline transparent
	\ifstrempty{#1}{%
		\footlinepayoff{}
		\setbeamercolor{footline}{fg=darkgray, bg=}
		\setbeamercolor{block title}{fg=white,bg=maincolor}
		\setbeamercolor{block body}{fg=white,bg=maincolor}
	}{
		\footlinepayoff{\@footlineauthor\inserttitle}
		\setbeamercolor{footline}{fg=white,bg=#1}
		\setbeamercolor{block title}{fg=white,bg=#1}
		\setbeamercolor{block body}{fg=white,bg=#1}
	}%
}
\footlinecolor{} % Default: no footline

\pgfdeclareimage[width=0.07\paperwidth]{logo}{images/Logo_Unisi_2012_transp}%assets/logo_RGB}
\pgfdeclareimage[width=0.07\paperwidth]{whitelogo}{images/Logo_Unisi_2012_inver}%assets/logo_RGB_negative}
\newcommand{\atlogo}{logo}

\newcommand{\themecolor}[1]{
\ifstrequal{#1}{main}{%
\setbeamercolor{footline}{fg=white}
\setbeamercolor{normal text}{fg=white,bg=maincolor}
\setbeamercolor{structure}{fg=white}
\renewcommand{\atlogo}{whitelogo}
\setbeamercolor{block title}{fg=maincolor,bg=sintefgrey}
\setbeamercolor{block body}{fg=darkgray,bg=sintefgrey}
}{%
\setbeamercolor{footline}{fg=darkgray}
\setbeamercolor{normal text}{fg=darkgray,bg=white}
\setbeamercolor{structure}{fg=maincolor}
\renewcommand{\atlogo}{logo}
\setbeamercolor{block title}{fg=white,bg=maincolor}
\setbeamercolor{block body}{fg=darkgray,bg=sintefgrey}
}
}
\themecolor{white} % Default: white theme

\setbeamercolor{title}{fg=maincolor,bg=white}
\setbeamercolor{alerted text}{fg=sintefred}
\setbeamercolor{author}{fg=black}
\setbeamercolor{date}{fg=black}

\usefonttheme{professionalfonts}
%\usepackage{cmbright}
%\usepackage [ T1 ]{ fontenc }
%\usepackage { concmath }
%\setbeamerfont{author}{size=\scriptsize, family=\fontfamily{cmbright}}
%\setbeamerfont{date}{size=\tiny, family=\fontfamily{cmbright}}
\setbeamerfont{title}{series=\bfseries, size=\huge}
\setbeamerfont{subtitle}{series=\mdseries,size=\footnotesize}
\setbeamerfont{frametitle}{size=\huge}
\setbeamerfont{framesubtitle}{series=\mdseries}
%\setbeamerfont{footline}{size=\scriptsize}
\setbeamerfont{block title}{series=\centering}
\setbeamerfont{normal text}{series=\centering}
%\setbeamerfont{block body}{series=\centering}

% Code to get prettier boxes
\setbeamertemplate{blocks}[rounded]

% Bullets in several levels
\setbeamertemplate{itemize item}{\textbullet}
\setbeamertemplate{itemize subitem}{\footnotesize\ensuremath{\odot}}
\setbeamertemplate{itemize subsubitem}{\ensuremath{\circ}}

%\newenvironment{colorblock}[3][white]{%
%	\begingroup
%	\setbeamercolor{block title}{fg=#1,bg=#2}
%	\setbeamercolor{block body} {fg=#1,bg=#2}
%	\begin{block}{#3}
%	}{%
%	\end{block}
%	\endgroup
%}

% Put the logo in each slide's top left area
\setbeamertemplate{headline}{\hspace{0.01\textwidth}\pgfuseimage{\atlogo}}

% Define frame title and subtitle layout
\setbeamertemplate{frametitle}{%
\vspace*{-2.65ex}
\begin{beamercolorbox}[leftskip=2cm]{frametitle}%
\usebeamerfont{frametitle}\insertframetitle\\
\usebeamerfont{framesubtitle}\insertframesubtitle
\end{beamercolorbox}
%\vspace{0.05cm}
%\hrule
}

\def\atcourseLabel{}
\newcommand{\course}[1]{\def\atcourseLabel{#1}}

\pgfdeclareimage[width=0.15\linewidth]{mybackground}{images/mps}
\pgfdeclareimage[width=1.\linewidth]{abstract}{images/abstract_title}
% Define the title page
\setbeamertemplate{title page}{%
\vskip0pt plus 1filll%
% Reposition the box in an inelegant way - but it works!
\hspace{-10mm}
\vspace{20mm}
\begin{beamercolorbox}[wd=0.72\textwidth,sep=10pt,leftskip=8mm]{title}%
{\usebeamerfont{title}\inserttitle}

{\usebeamerfont{subtitle}\insertsubtitle}

\vspace{0.5cm}

{\usebeamerfont{subtitle}\atcourseLabel}

{\usebeamerfont{author}\usebeamercolor[fg]{author}\textbf{\insertauthor}}

\begin{picture}(0,0)
	\put(-2, -20){%
		\pgfuseimage{mybackground}
	}
\end{picture}
\begin{picture}(0,0)
	\put(145, -70){%
		\pgfuseimage{abstract}
	}
\end{picture}
%{\usebeamerfont{date}\usebeamercolor[fg]{date}\insertdate}
\end{beamercolorbox}
}

% Define slide splitting dimensions (e.g. title and chapter slides)
\newcommand{\TikzSplitSlide}[1]{%
\rule{0.56\paperwidth}{0pt}%
\begin{tikzpicture}
\clip (-0.1\paperwidth,-0.5\paperheight) -- 
( 0.5\paperwidth,-0.5\paperheight) -- 
( 0.5\paperwidth, 0.5\paperheight) -- 
( 0.1\paperwidth, 0.5\paperheight) -- cycle; 
\node at (0.2\paperwidth,0) {%
	\includegraphics[height=\paperheight]{#1}%
};
\end{tikzpicture}
}

\makeatletter
\newenvironment{withoutheadline}{
\setbeamertemplate{headline}[default]
\def\beameratentrycode{\vspace*{-\headheight}}
}{}
\makeatother

% Define sectioning and table of contents
\AtBeginSection[]
{
\begingroup
\themecolor{main}
\begin{frame}{Table of Contents}
\begin{multicols}{2}
\tableofcontents[currentsection]
\end{multicols}
\end{frame}
\endgroup
}

% style of section presented in the table of contents
\setbeamertemplate{section in toc}{$\blacktriangleright$~\inserttocsection}

% automate subtitle of each frame
\makeatletter
\pretocmd\beameratcheckframetitle{\framesubtitle{\thesection \, \secname}}
\makeatother

% avoid numbering of frames that are breaked into multiply slides
\setbeamertemplate{frametitle continuation}{}

%\newcommand\hmmax{0}
%\newcommand\bmmax{0}

%\usefonttheme[onlymath]{serif}
\let\olditem\item\renewcommand{\item}[1][black]{\color{#1}\olditem}

%\usepackage[T1]{fontenc}
%\usepackage{emerald}

\newenvironment{homework}{
	\setbeamertemplate{background}{\includegraphics[width=\paperwidth,height=\paperheight]{images/blackboard}}
	\setbeamertemplate{itemize item}{\color{white}\textbullet}
	\setbeamertemplate{itemize subitem}{\color{white}\footnotesize\ensuremath{\odot}}
	\setbeamertemplate{itemize subsubitem}{\color{white}\ensuremath{\circ}}
	%\setbeamerfont{frametitle}{size=\huge, series=\ECFAugie}
	%\setbeamerfont{framesubtitle}{size=\large, family=\fontfamily{emerald}}
	%\setbeamerfont{title}{size=\huge, family=\fontfamily{emerald}, series=\ECFAugie}
    %\setbeamerfont{block title}{series=\ECFAugie}
    %\setbeamerfont{item}{series=\ECFAugie}
    %\setbeamerfont{item subitem}{series=\ECFAugie}
	%\setbeamerfont{caption}{family=\fontfamily{emerald}}
    \setbeamerfont{block body}{series=\ECFAugie}
    \setbeamerfont{normal text}{size=\normal, series=\ECFAugie}
}{\par}

\usepackage{tcolorbox}
\tcbuselibrary{minted,breakable,xparse,skins}

\definecolor{bg}{gray}{0.95}
\DeclareTCBListing{mintedbox}{O{}m!O{}}{%
  breakable=true,
  listing engine=minted,
  listing only,
  minted language=#2,
  minted style=default,
  minted options={%
    linenos,
    gobble=0,
    breaklines=true,
    breakafter=,,
    fontsize=\tiny,
    numbersep=8pt,
    #1},
  boxsep=0pt,
  left skip=0pt,
  right skip=0pt,
  left=25pt,
  right=0pt,
  top=3pt,
  bottom=3pt,
  arc=5pt,
  leftrule=0pt,
  rightrule=0pt,
  bottomrule=2pt,
  toprule=2pt,
  colback=bg,
  colframe=orange!70,
  enhanced,
  overlay={%
    \begin{tcbclipinterior}
    \fill[orange!20!white] (frame.south west) rectangle ([xshift=20pt]frame.north west);
    \end{tcbclipinterior}},
  #3,
}

\usepackage{xcolor}
\definecolor{ipython-frame}{RGB}{207, 207, 207}
\definecolor{ipython-bg}{RGB}{247, 247, 247}
\definecolor{ipython-red}{RGB}{186, 33, 33}
\definecolor{ipython-green}{RGB}{0, 128, 0}
\definecolor{ipython-cyan}{RGB}{64, 128, 128}
\definecolor{ipython-purple}{RGB}{170, 34, 255}

\usepackage{listings}
\usepackage{cprotect}
\lstdefinelanguage{iPython} {
	morekeywords={access,and,del,except,exec,in,is,lambda,not,or,raise},
	morekeywords=[2]{for,print,abs,all,any,basestring,bin,bool,bytearray,callable,chr,classmethod,cmp,compile,complex,delattr,dict,dir,divmod,enumerate,eval,execfile,file,filter,float,format,frozenset,getattr,globals,hasattr,hash,help,hex,id,input,int,isinstance,issubclass,iter,len,list,locals,long,map,max,memoryview,min,next,object,oct,open,ord,pow,property,range,reduce,reload,repr,reversed,round,set,setattr,slice,sorted,staticmethod,str,sum,super,tuple,type,unichr,unicode,vars,xrange,zip,apply,buffer,coerce,intern,elif,else,if,continue,break,while,class,def,return,try,except,import,finally,try,except,from,global,pass, True, False},
	sensitive=true,
	morecomment=[l]\#,
	morestring=[b]',
	morestring=[b]",
	moredelim=**[is][\color{black}]{@@}{@@},
	identifierstyle=\color{black}\tiny\ttfamily,
    commentstyle=\color{ipython-cyan}\tiny\itshape\ttfamily,
	stringstyle=\color{ipython-red}\tiny\ttfamily,
	keepspaces=true,
	showspaces=false,
    showstringspaces=false,
	rulecolor=\color{ipython-cyan},
    basewidth=0.5em,
    frame=single,
	frameround={t}{t}{t}{t},
	framexleftmargin=0mm,
	numbers=none,
	numberstyle=\color{black}\bfseries\tiny\ttfamily,
	basicstyle=\footnotesize\ttfamily,
	keywordstyle=[2]\color{ipython-green}\bfseries\tiny\ttfamily, 
	mathescape=true,
	escapeinside={*@}{@*},
    basicstyle=\tiny,
}

\newcommand{\pythoncode}[2]{
\lstinputlisting[language=iPython,numbers=none,backgroundcolor=\color{ipython-bg},linewidth=#2]{#1}
}

\lstnewenvironment{ioutput}[1][1\linewidth]{\lstset{language=bash,basicstyle=\color{white}\bfseries\tiny\ttfamily, backgroundcolor=\color{black}, rulecolor=\color{black}, numbers=none, framextopmargin=0, framexbottommargin=0, framexleftmargin=1mm, linewidth=#1}}{}

\lstnewenvironment{ipython}[1][]{\lstset{language=iPython,numbers=none,#1}}{}

\newenvironment{codebox}
{\begin{center}\begin{minipage}{\linewidth}}
{\end{minipage}\end{center}}
